!function(){const t="emoteCache7TV";class e{constructor(){this.emotes={}}async init(){const{channelId:t,apiToken:e}=this.extractChannelInfo();t&&e?(this.emotes=await this.loadEmotes(t,e),this.replaceEmotesInElement(document.getElementById("message"))):console.error("[EmoteReplacer] Missing channelId or apiToken")}validateCache(t,e){return t?.data&&t.timestamp?{valid:!0,data:t.data,isFresh:Date.now()-t.timestamp<e}:{valid:!1}}async fetchWithErrorHandling(t,e){const n=await fetch(t,e);if(!n.ok)throw new Error(`HTTP ${n.status}`);return n.json()}async getCache(e,n){try{const a=`https://kvstore.streamelements.com/v2/channel/${e}/customWidget.${t}`,o=await this.fetchWithErrorHandling(a,{headers:{Authorization:`apikey ${n}`,"Content-Type":"application/json"}});return this.validateCache(o,72e6)}catch(t){return console.log("[getCache] Error:",t),{valid:!1}}}async setCache(e,n,a){try{const o=`https://kvstore.streamelements.com/v2/channel/${e}`;return await this.fetchWithErrorHandling(o,{method:"PUT",headers:{Authorization:`apikey ${n}`,"Content-Type":"application/json"},body:JSON.stringify({key:`customWidget.${t}`,value:{data:a,timestamp:Date.now()}})})}catch(t){return console.error("[setCache] Error:",t),null}}async fetchProviderInfo(t){return this.fetchWithErrorHandling(`https://api.streamelements.com/kappa/v2/channels/${t}/`)}async fetch7TVEmotes(t,e){const{emote_set:n}=await this.fetchWithErrorHandling(`https://7tv.io/v3/users/${t}/${e}`);return Object.fromEntries((n?.emotes||[]).filter((t=>!1===t.data.listed)).map((t=>{const e=t.data.host.files[0]?.name;return[t.data.name,{url:`https:${t.data.host.url}/${e}`}]})))}async fetchEmotes(t){const{provider:e,providerId:n}=await this.fetchProviderInfo(t);return this.fetch7TVEmotes(e,n)}async loadEmotes(t,e){const n=await this.getCache(t,e);if(n.valid&&n.isFresh)return n.data;try{const n=await this.fetchEmotes(t);return this.setCache(t,e,n).catch((t=>console.log("[loadEmotes] Cache update failed:",t))),n}catch{return n.valid?n.data:{}}}extractChannelInfo(){const t=Array.from(document.scripts).find((t=>t.textContent.includes("apiToken")));if(!t)return{};const e=t.textContent.match(/"apiToken":\s*"([^"]+)"/)?.[1],n=t.textContent.match(/"id":\s*"([^"]+)"/)?.[1];return{channelId:n,apiToken:e}}replaceEmotesInElement(t){if(!t||!this.emotes)return;const e=document.createElement("div");e.innerHTML=t.innerHTML;const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:t=>{const e=t.parentNode?.tagName?.toLowerCase();return t.nodeValue.trim()&&!["img","a","button","script","style"].includes(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),a=[];for(;n.nextNode();)a.push(n.currentNode);a.forEach((t=>{const e=document.createDocumentFragment();let n=!1;t.textContent.split(/(\s+)/).forEach((t=>{if(this.emotes[t]){const a=document.createElement("img");Object.assign(a,{src:this.emotes[t].url,alt:t,className:"alertbox-message-emote"}),e.appendChild(a),n=!0}else e.appendChild(document.createTextNode(t))})),n&&t.parentNode.replaceChild(e,t)})),t.innerHTML=e.innerHTML}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>(new e).init())):(new e).init()}();
