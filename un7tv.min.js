!function(){const t="emoteCache7TV";class e{constructor(){this.emotes={}}async init(){const{channelId:t,apiToken:e}=this.extractChannelInfo();t&&e?(this.emotes=await this.loadEmotes(t,e),this.replaceEmotesInElement(document.getElementById("message"))):console.error("[EmoteReplacer] Missing channelId or apiToken")}get7TVUserIdFromParam(){const t=Array.from(document.scripts).find((t=>t.src.includes("sau-paramtest.min.js")));if(!t)return null;return new URL(t.src).searchParams.get("7tv_user")||null}validateCache(t,e){return t?.data&&t.timestamp?{valid:!0,data:t.data,isFresh:Date.now()-t.timestamp<e}:{valid:!1}}async fetchWithErrorHandling(t,e){const a=await fetch(t,e);if(!a.ok)throw new Error(`HTTP ${a.status}`);return a.json()}async getCache(e,a){try{const n=`https://kvstore.streamelements.com/v2/channel/${e}/customWidget.${t}`,r=await this.fetchWithErrorHandling(n,{headers:{Authorization:`apikey ${a}`,"Content-Type":"application/json"}});return this.validateCache(r,36e5)}catch(t){return console.log("[getCache] Error:",t),{valid:!1}}}async setCache(e,a,n){try{const r=`https://kvstore.streamelements.com/v2/channel/${e}`;return await this.fetchWithErrorHandling(r,{method:"PUT",headers:{Authorization:`apikey ${a}`,"Content-Type":"application/json"},body:JSON.stringify({key:`customWidget.${t}`,value:{data:n,timestamp:Date.now()}})})}catch(t){return console.error("[setCache] Error:",t),null}}async fetchProviderInfo(t){return this.fetchWithErrorHandling(`https://api.streamelements.com/kappa/v2/channels/${t}/`)}async fetch7TVEmotes(t,e){const{emote_set:a}=await this.fetchWithErrorHandling(`https://7tv.io/v3/users/${t}/${e}`);return console.log("fetching old way"),this.formatEmotes(a?.emotes)}async fetch7TVEmotesByUserId(t){const{emote_set:e}=await this.fetchWithErrorHandling(`https://7tv.io/v3/users/${t}`);return console.log("fetching with 7tv id"),this.formatEmotes(e?.emotes)}formatEmotes(t){return Object.fromEntries((t||[]).filter((t=>!1===t.data.listed)).map((t=>{const e=t.data.host.files[0]?.name;return[t.data.name,{url:`https:${t.data.host.url}/${e}`}]})))}async loadEmotes(t,e){const a=this.get7TVUserIdFromParam();if(a)try{return await this.fetch7TVEmotesByUserId(a)}catch(t){console.warn("[7TV] Direct fetch by user ID failed, falling back to cache + API method...")}const n=await this.getCache(t,e);if(n.valid&&n.isFresh)return n.data;try{const{provider:a,providerId:n}=await this.fetchProviderInfo(t),r=await this.fetch7TVEmotes(a,n);return this.setCache(t,e,r).catch((t=>console.log("[loadEmotes] Cache update failed:",t))),r}catch(t){return console.warn("[7TV] Fallback fetch failed:",t),n.valid?n.data:{}}}extractChannelInfo(){const t=Array.from(document.scripts).find((t=>t.textContent.includes("apiToken")));if(!t)return{};const e=t.textContent.match(/"apiToken":\s*"([^"]+)"/)?.[1],a=t.textContent.match(/"id":\s*"([^"]+)"/)?.[1];return{channelId:a,apiToken:e}}replaceEmotesInElement(t){if(!t||!this.emotes)return;const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:t=>{const e=t.parentNode?.tagName?.toLowerCase();return t.nodeValue.trim()&&!["img","a","button","script","style"].includes(e)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),a=[];for(;e.nextNode();)a.push(e.currentNode);a.forEach((t=>{const e=t.parentNode,a=t.textContent.split(/(\s+)/);let n=!1;const r=document.createDocumentFragment();a.forEach((t=>{if(this.emotes[t]){const e=document.createElement("img");Object.assign(e,{src:this.emotes[t].url,alt:t,className:"alertbox-message-emote"}),r.appendChild(e),n=!0}else r.appendChild(document.createTextNode(t))})),n&&e.replaceChild(r,t)}))}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>(new e).init())):(new e).init()}();
