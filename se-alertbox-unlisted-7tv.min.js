const emotes={},cacheKey="emoteCache7TV",cacheDuration=72e6,validateCache=(e,t)=>e?.data&&e.timestamp?{valid:!0,data:e.data,isFresh:Date.now()-e.timestamp<t}:{valid:!1},fetchWithErrorHandling=async(e,t)=>{const a=await fetch(e,t);if(!a.ok)throw new Error(`HTTP ${a.status}`);return a.json()},getCache=async(e,t)=>{try{const r=`https://kvstore.streamelements.com/v2/channel/${e}/customWidget.${cacheKey}`,o=await fetchWithErrorHandling(r,{headers:{Authorization:`apikey ${t}`,"Content-Type":"application/json"}});return a=o,n=72e6,a?.data&&a.timestamp?{valid:!0,data:a.data,isFresh:Date.now()-a.timestamp<n}:{valid:!1}}catch(e){return console.log("[getCache] Error:",e),{valid:!1}}var a,n},setCache=async(e,t,a)=>{try{const n=`https://kvstore.streamelements.com/v2/channel/${e}`;return await fetchWithErrorHandling(n,{method:"PUT",headers:{Authorization:`apikey ${t}`,"Content-Type":"application/json"},body:JSON.stringify({key:`customWidget.${cacheKey}`,value:{data:a,timestamp:Date.now()}})})}catch(e){return console.error("[setCache] Error:",e),null}},fetchProviderInfo=async e=>fetchWithErrorHandling(`https://api.streamelements.com/kappa/v2/channels/${e}/`),fetch7TVEmotes=async(e,t)=>{const{emote_set:a}=await fetchWithErrorHandling(`https://7tv.io/v3/users/${e}/${t}`);return Object.fromEntries((a?.emotes||[]).filter((e=>!1===e.data.listed)).map((e=>{const t=e.data.host.files[0]?.name;return[e.data.name,{url:`https:${e.data.host.url}/${t}`}]})))},fetchEmotes=async e=>{const{provider:t,providerId:a}=await fetchProviderInfo(e);return fetch7TVEmotes(t,a)},loadEmotes=async(e,t)=>{const a=await getCache(e,t);if(a.valid&&a.isFresh)return a.data;try{const a=await fetchEmotes(e);return setCache(e,t,a).catch((e=>console.log("[loadEmotes] Cache update failed:",e))),a}catch{return a.valid?a.data:{}}},extractChannelInfo=()=>{const e=Array.from(document.scripts).find((e=>e.textContent.includes("apiToken")));if(!e)return{};const t=e.textContent.match(/"apiToken":\s*"([^"]+)"/)?.[1],a=e.textContent.match(/"id":\s*"([^"]+)"/)?.[1];return{channelId:a,apiToken:t}},replaceEmotesInElement=(e,t)=>{if(!e||!t)return;const a=document.createElement("div");a.innerHTML=e.innerHTML;const n=document.createTreeWalker(a,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const t=e.parentNode?.tagName?.toLowerCase();return e.nodeValue.trim()&&!["img","a","button","script","style"].includes(t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),r=[];for(;n.nextNode();)r.push(n.currentNode);r.forEach((e=>{const a=document.createDocumentFragment();let n=!1;e.textContent.split(/(\s+)/).forEach((e=>{if(t[e]){const r=document.createElement("img");Object.assign(r,{src:t[e].url,alt:e,className:"alertbox-message-emote"}),a.appendChild(r),n=!0}else a.appendChild(document.createTextNode(e))})),n&&e.parentNode.replaceChild(a,e)})),e.innerHTML=a.innerHTML},init=async()=>{const{channelId:e,apiToken:t}=extractChannelInfo();if(!e||!t)return console.error("[init] Missing channelId or apiToken");Object.assign(emotes,await loadEmotes(e,t)),replaceEmotesInElement(document.getElementById("message"),emotes)};init();
